<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Annotation Upload</title>
    <style>
      #canvasContainer {
        position: relative;
        display: inline-block;
        border: 1px solid #ccc;
      }
      canvas {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <h2>Upload Image and Annotate</h2>
    <input type="file" id="fileInput" accept="image/*" /><br /><br />
    <div id="canvasContainer">
      <canvas id="canvas"></canvas>
    </div>
    <br />
    <button id="uploadBtn">Upload to Backend</button>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      let image = new Image();
      let startX, startY;
      let drawing = false;
      let boxes = []; // Store bounding boxes

      // Load selected image onto canvas
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (ev) {
          image.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });

      image.onload = function () {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
      };

      // Draw bounding box
      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        drawing = true;
      });

      canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // redraw image
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);

        // redraw previous boxes
        boxes.forEach((b) => {
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(b.x, b.y, b.width, b.height);
        });

        // draw current box
        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, x - startX, y - startY);
      });

      canvas.addEventListener("mouseup", (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;
        drawing = false;

        // Save box
        boxes.push({
          x: Math.min(startX, endX),
          y: Math.min(startY, endY),
          width: Math.abs(endX - startX),
          height: Math.abs(endY - startY),
        });

        // redraw all boxes
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0);
        boxes.forEach((b) => {
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(b.x, b.y, b.width, b.height);
        });

        console.log("Boxes:", boxes);
      });

      // Upload to backend
      document
        .getElementById("uploadBtn")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("fileInput");
          if (!fileInput.files.length) return alert("Select an image first");

          const fd = new FormData();
          fd.append("project_id", "64f9a1b8a2b3c123456789ab"); // example project_id
          fd.append("images", fileInput.files[0]);
          fd.append("annotations", JSON.stringify(boxes));

          console.log("FormData ready:", fd);

          try {
            const res = await fetch("http://127.0.0.1:5000/images/upload", {
              method: "POST",
              body: fd,
            });
            const data = await res.json();
            console.log("Backend response:", data);
            alert("Upload finished. Check console for details.");
          } catch (err) {
            console.error("Upload error:", err);
            alert("Upload failed. See console.");
          }
        });
    </script>
  </body>
</html>
